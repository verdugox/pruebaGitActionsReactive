name: CI/CD Pipeline for AKS

on:
  push:
    branches:
      - develop  # Ejecutar solo en 'develop'
  workflow_dispatch:  # Permitir ejecución manual

jobs:
  build-and-push:
    runs-on: ubuntu-latest

    steps:
      # 1. Descargar código fuente
      - name: Checkout code
        uses: actions/checkout@v3

      # 2. Verificar ubicación de archivos
      - name: Print current workspace
        run: |
          echo "Ubicación actual del workspace:"
          pwd
          echo "Lista de archivos en el workspace:"
          ls -R

      # 3. Configurar JDK 17
      - name: Set up Java version
        uses: actions/setup-java@v3
        with:
          java-version: '17'
          distribution: 'temurin'

      # 4. Construir la aplicación con Maven
      - name: Build with Maven
        working-directory: ./client-service
        run: mvn clean install

      # 5. Iniciar sesión en Docker Hub
      - name: Login to Docker Hub
        uses: docker/login-action@v3
        with:
          username: ${{ secrets.DOCKER_USERNAME }}
          password: ${{ secrets.DOCKER_PASSWORD }}

      # 6. Construir la imagen de Docker
      - name: Build Docker Image
        working-directory: ./client-service
        run: docker build -t verdugox/springboot-app:1.0 .

      # 7. Subir la imagen a Docker Hub
      - name: Push Docker Image
        run: docker push verdugox/springboot-app:1.0

  deploy-to-aks:
    needs: build-and-push
    runs-on: ubuntu-latest

    steps:
      # 1. Autenticarse en Azure
      - name: Azure Login
        uses: azure/login@v1
        with:
          creds: ${{ secrets.AZURE_CREDENTIALS }}

      # 2. Configurar contexto de AKS
      - name: Set AKS Context
        run: az aks get-credentials --resource-group ${{ secrets.AKS_RESOURCE_GROUP }} --name ${{ secrets.AKS_CLUSTER }}

      # 3. Verificar la existencia de `k8s/`
      - name: Debug Kubernetes YAML files
        run: |
          echo "Verificando archivos de despliegue..."
          ls -R $GITHUB_WORKSPACE || true

      # 4. Asegurar que `k8s/` existe antes de proceder
      - name: Ensure k8s directory exists
        run: |
          if [ ! -d "$GITHUB_WORKSPACE/k8s" ]; then
            echo "ERROR: La carpeta 'k8s/' no existe en el workspace."
            exit 1
          fi
          echo "Carpeta 'k8s/' encontrada correctamente."

      # 5. Aplicar los archivos de Kubernetes (con espera)
      - name: Deploy to AKS
        run: |
          echo "Esperando 5 segundos para asegurar disponibilidad..."
          sleep 5
          kubectl apply -f $GITHUB_WORKSPACE/k8s/deployment.yaml
          kubectl apply -f $GITHUB_WORKSPACE/k8s/service.yaml

      # 6. Verificar los pods después del despliegue
      - name: List Kubernetes Pods
        run: kubectl get pods -o wide

      # 7. Reiniciar los pods después del despliegue
      - name: Restart AKS Pods
        run: kubectl rollout restart deployment springboot-app
